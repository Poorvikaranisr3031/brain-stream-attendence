<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance â€” Recognition + PDF Export</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
  <!-- BlazeFace (face detection) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
  <!-- MobileNet (for embeddings) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--bg:#0b1220;--card:#0f1724;--muted:#98a8c0;--accent:#2563eb}
    body{background:var(--bg);color:#e6eef8;font-family:Arial,Helvetica,sans-serif;padding:18px}
    h1{margin:0 0 6px 0}
    .wrap{max-width:1100px;margin:0 auto}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .muted{color:var(--muted);font-size:13px}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6eef8;padding:8px 12px;border-radius:8px;cursor:pointer}
    input[type="file"]{display:none}
    .small{font-size:13px;color:var(--muted)}
    .thumb{width:56px;height:56px;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);object-fit:cover}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
    .record{padding:8px;border-radius:8px;background:#0e1a2a;margin-top:8px}
    #previewBox{position:relative;display:inline-block}
    canvas{position:absolute;left:0;top:0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ“‹ Attendance â€” Recognition + PDF Export</h1>
    <div class="muted">Register students (upload 1â€“5 clear face photos each), then upload a classroom photo to mark attendance.</div>

    <div class="grid">
      <!-- LEFT: Student registration + controls -->
      <div>
        <div class="card">
          <div style="font-weight:600">Add / Register Student</div>
          <div class="small muted" style="margin-top:6px">Name + 1â€“5 photos (front face preferred)</div>

          <input id="studentName" class="input" placeholder="Student name" style="width:100%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <label class="btn-ghost" for="studentFiles" style="cursor:pointer">Upload Photos</label>
            <input id="studentFiles" type="file" accept="image/*" multiple>
            <button id="addStudentBtn" class="btn">Add Student</button>
          </div>

          <div id="studentPreview" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

          <div style="font-weight:600">Attendance</div>
          <div class="small muted" style="margin-top:6px">Upload classroom photo and click Detect.</div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <label class="btn-ghost" for="classFile" style="cursor:pointer">Upload Classroom Photo</label>
            <input id="classFile" type="file" accept="image/*">
            <button id="detectBtn" class="btn">Detect & Mark</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
            <button id="exportPdfBtn" class="btn">Export Attendance PDF</button>
            <button id="clearAllBtn" class="btn-ghost">Clear students & attendance</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="font-weight:600">Registered Students</div>
          <div id="studentsList" style="margin-top:10px;max-height:320px;overflow:auto"></div>
        </div>
      </div>

      <!-- RIGHT: Preview + attendance table -->
      <div>
        <div class="card" style="min-height:420px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">Preview & Detections</div>
            <div class="small muted" id="status">Models: loading...</div>
          </div>

          <div style="margin-top:12px">
            <div id="previewBox">
              <img id="preview" style="max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.03);" />
              <canvas id="overlay"></canvas>
            </div>

            <div id="resultPanel" style="margin-top:12px;display:none">
              <div style="font-weight:600">Attendance Result</div>
              <div class="small muted" style="margin-top:6px">Detected people and matched students</div>

              <table id="attTable">
                <thead><tr><th>Time</th><th>Name</th><th>Confidence</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="font-weight:600">Quick Help</div>
          <div class="small muted" style="margin-top:6px">
            â€¢ Register students first (2â€“4 clear photos each for best results).<br>
            â€¢ Then upload a classroom photo and click Detect.<br>
            â€¢ Use Export PDF to download attendance sheet.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(async function(){

  // ---------------------------
  // Load models
  // ---------------------------
  const statusEl = document.getElementById('status');
  let detector, mobilenetModel;
  try {
    detector = await blazeface.load();
    mobilenetModel = await mobilenet.load({version:2,alpha:1.0});
    statusEl.textContent = "Models loaded âœ”";
  } catch (e) {
    statusEl.textContent = "Model load failed";
    alert("Model failed to load. Check internet or try a different browser.");
    console.error(e);
    return;
  }

  // ---------------------------
  // Utility functions
  // ---------------------------
  function cosineSimilarity(a, b) {
    let dot = 0, na = 0, nb = 0;
    for (let i=0;i<a.length;i++){
      dot += a[i]*b[i];
      na += a[i]*a[i];
      nb += b[i]*b[i];
    }
    return dot / (Math.sqrt(na) * Math.sqrt(nb) + 1e-8);
  }

  function avgEmbeddings(listOfEmb) {
    const n = listOfEmb.length;
    if (n === 0) return null;
    const L = listOfEmb[0].length;
    const out = new Array(L).fill(0);
    for (let i=0;i<n;i++){
      for (let j=0;j<L;j++) out[j] += listOfEmb[i][j];
    }
    for (let j=0;j<L;j++) out[j] /= n;
    return out;
  }

  // Convert an HTMLImageElement or canvas to a tensor suitable for mobilenet
  function imageToTensorForMobileNet(imgEl) {
    // mobilenet expects image tensor [H,W,3] in range [0,1]
    const tfImg = tf.browser.fromPixels(imgEl).toFloat().div(tf.scalar(255));
    // mobilenet.infer accepts image tensor and returns embeddings if second arg 'embedding' true
    return tfImg;
  }

  // crop and get embedding from face bbox (x,y,w,h) on the original-sized preview image
  async function getEmbeddingFromBox(imageEl, box) {
    // create temporary canvas of box size then resize to 224x224
    const [x, y, w, h] = box;
    if (w < 20 || h < 20) return null; // too small
    const tmp = document.createElement('canvas');
    tmp.width = Math.max(64, Math.round(w));
    tmp.height = Math.max(64, Math.round(h));
    const ctx = tmp.getContext('2d');
    ctx.drawImage(imageEl, x, y, w, h, 0, 0, tmp.width, tmp.height);
    // resize canvas to 224 for mobilenet
    const r = document.createElement('canvas');
    r.width = 224; r.height = 224;
    r.getContext('2d').drawImage(tmp, 0, 0, r.width, r.height);

    // get tensor and run mobilenet.infer with embedding flag
    const t = tf.browser.fromPixels(r).toFloat().div(tf.scalar(255));
    // mobilenet's infer with 'embedding' returns a tensor we can arraySync
    const embTensor = mobilenetModel.infer(t, true);
    const emb = embTensor.arraySync(); // [1,embeddingSize] or [embeddingSize]
    // cleanup tensors
    embTensor.dispose(); t.dispose();
    // normalize to 1D array
    return Array.isArray(emb[0]) ? emb[0] : emb;
  }

  // ---------------------------
  // Storage: students & attendance (localStorage)
  // ---------------------------
  const STUD_KEY = 'att_students_v1';
  const ATT_KEY = 'att_history_v1';

  function loadStudents() {
    try {
      const raw = localStorage.getItem(STUD_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch(e) { return {}; }
  }
  function saveStudents(obj) {
    localStorage.setItem(STUD_KEY, JSON.stringify(obj));
  }
  function loadAttendance() {
    try { const r = localStorage.getItem(ATT_KEY); return r ? JSON.parse(r) : []; } catch(e){return [];}
  }
  function saveAttendance(arr) { localStorage.setItem(ATT_KEY, JSON.stringify(arr)); }

  let students = loadStudents(); // { name: { photos: [dataUrl,...], embeddings: [[..],[..]] , avg: [...] } }
  let attendanceHistory = loadAttendance();

  // ---------------------------
  // UI wiring
  // ---------------------------
  const studentFiles = document.getElementById('studentFiles');
  const studentName = document.getElementById('studentName');
  const addStudentBtn = document.getElementById('addStudentBtn');
  const studentPreview = document.getElementById('studentPreview');
  const studentsList = document.getElementById('studentsList');

  const classFile = document.getElementById('classFile');
  const detectBtn = document.getElementById('detectBtn');
  const preview = document.getElementById('preview');
  const overlay = document.getElementById('overlay');
  const resultPanel = document.getElementById('resultPanel');
  const attTableBody = document.querySelector('#attTable tbody');

  const exportPdfBtn = document.getElementById('exportPdfBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');

  let selectedStudentFiles = [];

  studentFiles.addEventListener('change', e => {
    selectedStudentFiles = Array.from(e.target.files || []);
    studentPreview.innerHTML = '';
    selectedStudentFiles.forEach(file => {
      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = URL.createObjectURL(file);
      studentPreview.appendChild(img);
    });
  });

  function renderStudentsList() {
    studentsList.innerHTML = '';
    const keys = Object.keys(students);
    if (!keys.length) { studentsList.innerHTML = '<div class="small muted">No students registered</div>'; return; }
    keys.forEach(name => {
      const s = students[name];
      const div = document.createElement('div');
      div.className = 'record';
      div.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
        <div style="width:48px;height:48px;flex:0 0 48px;border-radius:6px;overflow:hidden"><img src="${s.photos[0]}" style="width:100%;height:100%;object-fit:cover"></div>
        <div style="flex:1"><strong>${name}</strong><div class="small muted">${(s.photos||[]).length} photos</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn-ghost" data-name="${name}" onclick="window.editStudent && window.editStudent(this.getAttribute('data-name'))">Edit</button>
          <button class="btn-ghost" data-name="${name}" onclick="window.deleteStudent && window.deleteStudent(this.getAttribute('data-name'))">Delete</button>
        </div>
      </div>`;
      studentsList.appendChild(div);
    });
  }

  window.deleteStudent = function(name) {
    if (!confirm('Delete '+name+'?')) return;
    delete students[name];
    saveStudents(students);
    renderStudentsList();
  };

  // Add student: compute embeddings for uploaded photos
  addStudentBtn.addEventListener('click', async () => {
    const name = (studentName.value || '').trim();
    if (!name) return alert('Enter student name');
    if (!selectedStudentFiles.length) return alert('Upload 1 or more photos for this student');

    // show loading
    addStudentBtn.disabled = true; addStudentBtn.textContent = 'Processing...';

    const photosData = [];
    const embeddingsList = [];

    for (let f of selectedStudentFiles) {
      try {
        const img = await fileToImage(f);
        // detect single face from the provided student image
        const preds = await detector.estimateFaces(img, false);
        if (!preds || preds.length === 0) {
          console.warn('No face in file', f.name);
          // still store full photo but skip embedding
          const dataUrl = await fileToDataUrl(f);
          photosData.push(dataUrl);
          continue;
        }
        // take first face
        const p = preds[0];
        const box = p.topLeft.concat(p.bottomRight); // [x,y, x2,y2]
        const x = Math.max(0, Math.round(box[0]));
        const y = Math.max(0, Math.round(box[1]));
        const x2 = Math.min(img.width, Math.round(box[2]));
        const y2 = Math.min(img.height, Math.round(box[3]));
        const w = x2 - x, h = y2 - y;
        const emb = await getEmbeddingFromBox(img, [x,y,w,h]); // using mobilenet
        if (emb) embeddingsList.push(emb);
        // store photo as dataURL
        const dataUrl = await fileToDataUrl(f);
        photosData.push(dataUrl);
      } catch (err) {
        console.error('student photo processing error', err);
      }
    }

    const avg = embeddingsList.length ? avgEmbeddings(embeddingsList) : null;
    students[name] = { photos: photosData, embeddings: embeddingsList, avg: avg };
    saveStudents(students);
    // reset inputs
    studentName.value = ''; studentFiles.value = ''; studentPreview.innerHTML = ''; selectedStudentFiles = [];
    addStudentBtn.disabled = false; addStudentBtn.textContent = 'Add Student';
    renderStudentsList();
    alert('Student added: ' + name + (avg ? ' (embeddings recorded)' : ' (no face embeddings found in uploaded photos)'));
  });

  // helper: convert file to dataURL
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  function fileToImage(file){ return new Promise((res,rej)=>{ const url = URL.createObjectURL(file); const img = new Image(); img.onload=()=>{ URL.revokeObjectURL(url); res(img); }; img.onerror=rej; img.src=url; }); }

  // helper: get embedding from box on image element
  async function getEmbeddingFromBox(imageEl, box) {
    try {
      // box: [x,y,w,h]
      const emb = await getEmbeddingFromBox_core(imageEl, box);
      return emb;
    } catch(e){ console.error(e); return null; }
  }

  // core: do actual embedding generation (same as previously defined)
  async function getEmbeddingFromBox_core(imageEl, box) {
    const [x,y,w,h] = box;
    if (w < 20 || h < 20) return null;
    const tmp = document.createElement('canvas');
    tmp.width = Math.max(64, Math.round(w));
    tmp.height = Math.max(64, Math.round(h));
    const ctx = tmp.getContext('2d');
    ctx.drawImage(imageEl, x, y, w, h, 0, 0, tmp.width, tmp.height);
    const r = document.createElement('canvas');
    r.width = 224; r.height = 224;
    r.getContext('2d').drawImage(tmp, 0, 0, r.width, r.height);
    const t = tf.browser.fromPixels(r).toFloat().div(tf.scalar(255));
    const embTensor = mobilenetModel.infer(t, true);
    const embArr = embTensor.arraySync();
    embTensor.dispose(); t.dispose();
    return Array.isArray(embArr[0]) ? embArr[0] : embArr;
  }

  // ---------------------------
  // Detection on classroom photo
  // ---------------------------
  detectBtn.addEventListener('click', async () => {
    const f = classFile.files[0];
    if (!f) return alert('Upload a classroom photo first');
    detectBtn.disabled = true; detectBtn.textContent = 'Detecting...';

    const classImg = await fileToImage(f);
    // show preview
    preview.src = classImg.src;
    preview.onload = async () => {
      // prepare overlay
      overlay.width = preview.width; overlay.height = preview.height;
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0,0,overlay.width,overlay.height);

      // detect faces using blazeface
      const preds = await detector.estimateFaces(preview, false);
      console.log('predictions length', preds.length);
      const results = []; // { name, confidence, time }

      // for each detection compute embedding and compare against students
      for (let i=0;i<preds.length;i++){
        const p = preds[i];
        const topLeft = p.topLeft; const bottomRight = p.bottomRight;
        const x = Math.max(0, Math.round(topLeft[0]));
        const y = Math.max(0, Math.round(topLeft[1]));
        const x2 = Math.min(preview.width, Math.round(bottomRight[0]));
        const y2 = Math.min(preview.height, Math.round(bottomRight[1]));
        const w = x2 - x, h = y2 - y;

        // draw box (light)
        ctx.strokeStyle = '#00ff99'; ctx.lineWidth = 2; ctx.strokeRect(x,y,w,h);

        const emb = await getEmbeddingFromBox(preview, [x,y,w,h]);
        let matchedName = 'Unknown'; let bestScore = -1;
        if (emb) {
          // compare with each student's avg embedding
          for (let name in students) {
            const s = students[name];
            if (!s.avg) continue;
            const sim = cosineSimilarity(emb, s.avg);
            if (sim > bestScore) { bestScore = sim; matchedName = name; }
          }
        }
        // threshold for acceptance (0.55-0.65 are common; adjust if needed)
        const THRESH = 0.58;
        if (bestScore >= THRESH) {
          // draw matched label
          ctx.fillStyle = '#00ff99'; ctx.font = '16px Arial'; ctx.fillText(matchedName + ' (' + (bestScore*100).toFixed(0) + '%)', x, Math.max(12,y-6));
          results.push({ name: matchedName, confidence: bestScore });
        } else {
          ctx.fillStyle = '#ffd166'; ctx.font = '14px Arial'; ctx.fillText('Unknown', x, Math.max(12,y-6));
          results.push({ name: 'Unknown', confidence: bestScore });
        }
      }

      // Mark attendance (unique names)
      const timeNow = new Date().toLocaleString();
      const presentNames = new Set();
      results.forEach(r=> { if (r.name && r.name !== 'Unknown') presentNames.add(r.name); });
      const presentList = Array.from(presentNames);
      // record attendance entries
      presentList.forEach(n => attendanceHistory.unshift({ time: timeNow, name: n, confidence: null }));
      // also optionally mark unknowns
      results.forEach((r, idx) => {
        if (r.name === 'Unknown') attendanceHistory.unshift({ time: timeNow, name: 'Unknown', confidence: r.confidence });
      });

      saveAttendance(attendanceHistory);
      renderAttendanceResults(results);
      detectBtn.disabled = false; detectBtn.textContent = 'Detect & Mark';
    };
  });

  // Render attendance table
  function renderAttendanceResults(results) {
    resultPanel.style.display = 'block';
    attTableBody.innerHTML = '';
    const now = new Date().toLocaleString();
    // show each detection
    results.forEach(r => {
      const tr = document.createElement('tr');
      const confTxt = (r.confidence && r.confidence > -0.5) ? (r.confidence*100).toFixed(0) + '%' : 'â€”';
      tr.innerHTML = <td>${now}</td><td>${r.name}</td><td>${confTxt}</td>;
      attTableBody.appendChild(tr);
    });
  }

  // ---------------------------
  // Export PDF
  // ---------------------------
  exportPdfBtn.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
