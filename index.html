<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Brain Stream Attendance — Hosted models (recommended)</title>

<!-- Use CDN for TF core (small) but models are loaded from same origin /models/ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/3.20.0/tf.min.js"></script>
<script src="https://unpkg.com/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
<script src="https://unpkg.com/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{--bg:#071020;--card:#0f1724;--muted:#98a8c0;--accent:#2563eb;--ok:#10b981}
body{background:var(--bg);color:#e6eef8;font-family:Inter,Arial,sans-serif;margin:0;padding:20px}
.wrap{max-width:1100px;margin:0 auto}
h1{margin:0 0 6px 0}
.muted{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:14px}
.card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:#e6eef8;cursor:pointer}
input[type=file]{display:none}
.small{font-size:13px;color:var(--muted)}
.thumb{width:56px;height:56px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px;text-align:left}
#previewImg{max-width:100%;border-radius:8px}
canvas{position:absolute;left:0;top:0}
.status-ok{color:var(--ok);font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Brain Stream Attendance</h1>
    <div class="muted">This version loads ML models from <code>/models/*</code> on the same GitHub Pages site. Upload the 4 model files to the repo as described below, then refresh this page.</div>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">Register Student</div>
            <div class="small muted">Models: <span id="ms-text">waiting</span></div>
          </div>
          <div class="small muted" style="margin-top:6px">Name + 1–5 clear frontal photos. After upload click Add Student.</div>

          <input id="studentName" placeholder="Student name" style="width:100%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <label for="studentFiles" class="btn-ghost" style="cursor:pointer">Upload Photos</label>
            <input id="studentFiles" type="file" accept="image/*" multiple>
            <button id="addStudentBtn" class="btn">Add Student</button>
          </div>

          <div id="studentPreview" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="font-weight:600">Attendance</div>
          <div class="small muted" style="margin-top:6px">Upload classroom photo and click Detect & Mark</div>

          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <label for="classFile" class="btn-ghost" style="cursor:pointer">Upload Photo</label>
            <input id="classFile" type="file" accept="image/*">
            <button id="detectBtn" class="btn">Detect & Mark</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
            <button id="exportPdfBtn" class="btn">Export Attendance PDF</button>
            <button id="clearAllBtn" class="btn-ghost">Clear Students & Records</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="font-weight:600">Registered Students</div>
          <div id="studentsList" style="margin-top:10px;max-height:260px;overflow:auto"></div>
        </div>
      </div>

      <div>
        <div class="card" style="min-height:420px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">Preview & Results</div>
            <div id="infoRight" class="small muted">Detected: <span id="countFaces">0</span></div>
          </div>

          <div style="margin-top:12px">
            <div id="previewContainer" style="position:relative;display:inline-block">
              <img id="previewImg"/>
              <canvas id="previewOverlay"></canvas>
            </div>

            <div id="resultPanel" style="margin-top:12px;display:none">
              <div style="font-weight:600">Attendance Result</div>
              <table id="attTable">
                <thead><tr><th>Time</th><th>Name</th><th>Confidence</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="font-weight:600">Help</div>
          <div class="small muted" style="margin-top:6px">
            • Upload 2–4 clear frontal photos per student for best results.<br>
            • Classroom photo faces should be reasonably large and not heavily occluded.<br>
            • After you upload the 4 model files below, refresh this page and wait until the status shows Models loaded.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* This index.html expects the four model files to be available at:
   /models/blazeface/model.json
   /models/blazeface/group1-shard1.bin
   /models/mobilenet/model.json
   /models/mobilenet/group1-shard1.bin
   (These are relative to the GitHub Pages root for your repo.)
*/

const statusEl = document.getElementById('ms-text');

function setStatus(s, ok=false){ statusEl.textContent = s; statusEl.className = ok ? 'status-ok' : ''; }

// attempt to load models from local /models path (same origin)
async function loadLocalModels(){
  try {
    setStatus('loading from /models...');
    // ensure tf loaded
    if(!window.tf) throw new Error('tf not present');
    // load blazeface and mobilenet by giving modelUrl pointing to local path
    const bf = await blazeface.load({ modelUrl: 'models/blazeface/model.json' });
    const mn = await mobilenet.load({ version:2, alpha:1.0, modelUrl: 'models/mobilenet/model.json' });
    setStatus('Models loaded ✔', true);
    return {bf,mn};
  } catch(e) {
    console.warn('local model load failed', e);
    setStatus('Models not found in /models. Upload them to the repo (see instructions).');
    throw e;
  }
}

// call loader
let detector = null, mobilenetModel = null;
loadLocalModels().then(res => { detector=res.bf; mobilenetModel=res.mn; }).catch(()=>{ /* nothing */ });

/* ---------- rest of app (same code as before) ---------- */

const STUD_KEY = 'bs_students_v_local';
const ATT_KEY = 'bs_att_v_local';
function loadStudents(){ try{ return JSON.parse(localStorage.getItem(STUD_KEY))||{} }catch{return{}}}
function saveStudents(s){ localStorage.setItem(STUD_KEY, JSON.stringify(s)); }
function loadAttendance(){ try{ return JSON.parse(localStorage.getItem(ATT_KEY))||[] }catch{return[]}}
function saveAttendance(a){ localStorage.setItem(ATT_KEY, JSON.stringify(a)); }

let students = loadStudents();
let attendance = loadAttendance();

function fileToData(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });}
function loadImage(url){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=url; });}
function cosine(a,b){ let d=0,na=0,nb=0; for(let i=0;i<a.length;i++){ d+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; } return d/(Math.sqrt(na)*Math.sqrt(nb)+1e-8); }
function avgEmb(list){ if(!list.length) return null; const L=list[0].length; const out=new Array(L).fill(0); list.forEach(e=>e.forEach((v,i)=>out[i]+=v)); return out.map(x=>x/list.length); }
async function embeddingFromBox(imgEl, [x,y,w,h]){
  if(!mobilenetModel) return null;
  if(w < 20 || h < 20) return null;
  const tmp = document.createElement('canvas'); tmp.width = Math.max(64, Math.round(w)); tmp.height = Math.max(64, Math.round(h));
  tmp.getContext('2d').drawImage(imgEl, x, y, w, h, 0, 0, tmp.width, tmp.height);
  const r = document.createElement('canvas'); r.width=224; r.height=224; r.getContext('2d').drawImage(tmp,0,0,224,224);
  const t = tf.browser.fromPixels(r).toFloat().div(tf.scalar(255));
  const embTensor = mobilenetModel.infer(t, true);
  const emb = embTensor.arraySync();
  embTensor.dispose(); t.dispose();
  return Array.isArray(emb[0]) ? emb[0] : emb;
}

/* UI wiring */
const studentFiles = document.getElementById('studentFiles');
const studentName = document.getElementById('studentName');
const addStudentBtn = document.getElementById('addStudentBtn');
const studentPreview = document.getElementById('studentPreview');
const studentsList = document.getElementById('studentsList');

const classFile = document.getElementById('classFile');
const detectBtn = document.getElementById('detectBtn');
const previewImg = document.getElementById('previewImg');
const previewOverlay = document.getElementById('previewOverlay');
const resultPanel = document.getElementById('resultPanel');
const attTableBody = document.querySelector('#attTable tbody');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const countFacesEl = document.getElementById('countFaces');

let selectedFiles = [];
studentFiles.addEventListener('change', e=>{
  selectedFiles = Array.from(e.target.files||[]);
  studentPreview.innerHTML = '';
  selectedFiles.forEach(f => { const img = document.createElement('img'); img.className='thumb'; img.src = URL.createObjectURL(f); studentPreview.appendChild(img); });
});

function renderStudents(){ studentsList.innerHTML=''; const keys=Object.keys(students); if(!keys.length){ studentsList.innerHTML='<div class="small muted">No students registered</div>'; return; } keys.forEach(name=>{ const s=students[name]; const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='8px 0'; const img=document.createElement('img'); img.className='thumb'; img.src=s.photos && s.photos[0] ? s.photos[0] : ''; const info=document.createElement('div'); info.innerHTML=<strong>${name}</strong><div class="small muted">${(s.photos||[]).length} photos</div>; row.appendChild(img); row.appendChild(info); studentsList.appendChild(row); }); }
renderStudents();

addStudentBtn.addEventListener('click', async ()=>{
  const name=(studentName.value||'').trim(); if(!name) return alert('Enter student name');
  if(!selectedFiles.length) return alert('Upload 1–5 photos');
  addStudentBtn.disabled=true; addStudentBtn.textContent='Processing...';
  const photos=[]; const embeddings=[];
  for(const f of selectedFiles){
    try{
      const data = await fileToData(f); photos.push(data);
      if(detector && mobilenetModel){
        const img = await loadImage(data);
        const preds = await detector.estimateFaces(img,false);
        if(preds && preds.length){
          const p = preds[0]; const x=Math.max(0, Math.round(p.topLeft[0])); const y=Math.max(0, Math.round(p.topLeft[1]));
          const x2=Math.min(img.width, Math.round(p.bottomRight[0])); const y2=Math.min(img.height, Math.round(p.bottomRight[1]));
          const w=x2-x, h=y2-y;
          const emb = await embeddingFromBox(img, [x,y,w,h]);
          if(emb) embeddings.push(emb);
        }
      }
    }catch(e){ console.warn('student photo error', e); }
  }
  const avg = embeddings.length ? avgEmb(embeddings) : null;
  students[name] = { photos, embeddings, avg };
  saveStudents(students);
  selectedFiles=[]; studentPreview.innerHTML=''; studentName.value=''; addStudentBtn.disabled=false; addStudentBtn.textContent='Add Student';
  renderStudents();
  alert('Student added: ' + name + (avg ? ' (embeddings saved)' : ' (no embeddings - models may not have been ready)'));
});

function renderAttendance(){ attTableBody.innerHTML=''; attendance.slice(0,200).forEach(r=>{ const tr=document.createElement('tr'); const conf=(r.confidence && r.confidence>-0.5)?(r.confidence*100).toFixed(0)+'%':'-'; tr.innerHTML=<td>${r.time}</td><td>${r.name}</td><td>${conf}</td>; attTableBody.appendChild(tr); }); resultPanel.style.display = attendance.length ? 'block' : 'none'; }
renderAttendance();

classFile.addEventListener('change', async ()=>{ if(!classFile.files[0]) return; const d=await fileToData(classFile.files[0]); previewImg.src=d; previewImg.onload=()=>{ previewOverlay.width=previewImg.width; previewOverlay.height=previewImg.height; previewOverlay.getContext('2d').clearRect(0,0,previewOverlay.width, previewOverlay.height); }; });

detectBtn.addEventListener('click', async ()=>{
  const file = classFile.files[0]; if(!file) return alert('Upload classroom photo first');
  detectBtn.disabled=true; detectBtn.textContent='Detecting...';
  try{
    if(!detector || !mobilenetModel){ alert('Models not ready yet. Wait a few seconds then try again.'); detectBtn.disabled=false; detectBtn.textContent='Detect & Mark'; return; }
    const data = await fileToData(file); previewImg.src=data; await new Promise(r=>previewImg.onload=r);
    previewOverlay.width = previewImg.width; previewOverlay.height = previewImg.height; const ctx = previewOverlay.getContext('2d'); ctx.clearRect(0,0,previewOverlay.width, previewOverlay.height);
    const preds = await detector.estimateFaces(previewImg,false);
    countFacesEl.textContent = preds.length;
    if(!preds || preds.length===0){ alert('No faces detected. Use a clearer photo.'); detectBtn.disabled=false; detectBtn.textContent='Detect & Mark'; return; }
    const THRESH=0.58; const now = new Date().toLocaleString(); const results=[];
    for(let i=0;i<preds.length;i++){ const p=preds[i]; const x=Math.max(0,Math.round(p.topLeft[0])); const y=Math.max(0,Math.round(p.topLeft[1])); const x2=Math.min(previewImg.width,Math.round(p.bottomRight[0])); const y2=Math.min(previewImg.height,Math.round(p.bottomRight[1])); const w=x2-x,h=y2-y; ctx.strokeStyle='#00ff99'; ctx.lineWidth=2; ctx.strokeRect(x,y,w,h); const emb = await embeddingFromBox(previewImg,[x,y,w,h]); let best='Unknown',bestScore=-1; if(emb){ for(const name in students){ const s=students[name]; if(!s.avg) continue; const sim=cosine(emb,s.avg); if(sim>bestScore){ bestScore=sim; best=name; } } } if(bestScore>=THRESH){ ctx.fillStyle='#00ff99'; ctx.font='16px Arial'; ctx.fillText(${best} (${(bestScore*100).toFixed(0)}%), x, Math.max(12,y-6)); results.push({time:now,name:best,confidence:bestScore}); } else { ctx.fillStyle='#ffd166'; ctx.font='14px Arial'; ctx.fillText('Unknown', x, Math.max(12,y-6)); results.push({time:now,name:'Unknown',confidence:bestScore}); } }
    results.forEach(r=>attendance.unshift(r)); saveAttendance(attendance); renderAttendance();
    alert(Processed ${results.length} faces — ${results.filter(r=>r.name!=='Unknown').length} matched.);
  } catch(err){ console.error(err); alert('Detection failed: '+(err && err.message?err.message:String(err))); } finally { detectBtn.disabled=false; detectBtn.textContent='Detect & Mark'; }
});

exportPdfBtn.addEventListener('click', ()=>{ if(!attendance.length) return alert('No attendance records to export.'); const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'pt',format:'a4'}); doc.setFontSize(18); doc.text('Attendance Report',40,60); doc.setFontSize(11); let y=90; doc.text('Time',40,y); doc.text('Name',260,y); doc.text('Confidence',480,y); y+=16; for(let i=0;i<attendance.length;i++){ const r=attendance[i]; const conf=(r.confidence&&r.confidence>-0.5)?(r.confidence*100).toFixed(0)+'%':'-'; doc.text(String(r.time),40,y); doc.text(String(r.name),260,y); doc.text(conf,480,y); y+=14; if(y>750){ doc.addPage(); y=40; } } doc.save('attendance_report.pdf'); });

clearAllBtn.addEventListener('click', ()=>{ if(!confirm('Clear students and attendance?')) return; students={}; attendance=[]; saveStudents(students); saveAttendance(attendance); renderStudents(); renderAttendance(); alert('Cleared'); });

function initFromStorage(){ students = loadStudents(); attendance = loadAttendance(); renderStudents(); renderAttendance(); }
initFromStorage();

/* expose for debug */
window._students = students; window._attendance = attendance;

</script>
</body>
</html>
